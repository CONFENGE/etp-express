# ============================================================================
# ETP EXPRESS - DOCKER COMPOSE (Development Environment)
# ============================================================================
#
# Stack completo para desenvolvimento local:
# - PostgreSQL 15 (database)
# - Backend NestJS (API)
# - Frontend React + Vite (UI)
#
# USAGE:
#   docker-compose up          # Start all services
#   docker-compose up -d       # Start in background
#   docker-compose down        # Stop all services
#   docker-compose logs -f     # Follow logs
#
# REQUIREMENTS:
#   - Docker Engine 20.10+
#   - Docker Compose V2
#   - .env file (copy from .env.template)
#
# ============================================================================

version: '3.8'

services:
  # ==========================================================================
  # POSTGRES DATABASE
  # ==========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: etp-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-etp_express}
      POSTGRES_USER: ${POSTGRES_USER:-etp_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-etp_password_dev}
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=en_US.UTF-8"
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups  # Mount backup directory
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-etp_user} -d ${POSTGRES_DB:-etp_express}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - etp-network

  # ==========================================================================
  # BACKEND (NestJS API)
  # ==========================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      target: development  # Multi-stage: development with hot-reload
    container_name: etp-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database
      DATABASE_URL: postgres://${POSTGRES_USER:-etp_user}:${POSTGRES_PASSWORD:-etp_password_dev}@postgres:5432/${POSTGRES_DB:-etp_express}

      # Server
      PORT: ${BACKEND_PORT:-3001}
      NODE_ENV: ${NODE_ENV:-development}

      # Authentication
      JWT_SECRET: ${JWT_SECRET:-dev_jwt_secret_change_in_production_PLEASE}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}

      # OpenAI API
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4-turbo-preview}

      # Perplexity API (optional)
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-}

      # Sentry Error Tracking (optional for development)
      SENTRY_DSN: ${SENTRY_DSN:-}
      SENTRY_TRACES_SAMPLE_RATE: ${SENTRY_TRACES_SAMPLE_RATE:-1.0}

      # Railway-specific (auto-set in production)
      RAILWAY_GIT_COMMIT_SHA: ${RAILWAY_GIT_COMMIT_SHA:-local-dev}
    ports:
      - "${BACKEND_PORT:-3001}:3001"
    volumes:
      # Hot-reload: mount source code
      - ./backend/src:/app/src
      - ./backend/test:/app/test
      # Prevent node_modules override
      - /app/node_modules
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3001/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - etp-network

  # ==========================================================================
  # FRONTEND (React + Vite)
  # ==========================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development  # Multi-stage: development with hot-reload
    container_name: etp-frontend
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    environment:
      # API URL (internal Docker network)
      VITE_API_URL: http://backend:3001/api

      # Node environment
      NODE_ENV: ${NODE_ENV:-development}

      # Sentry (optional for development)
      VITE_SENTRY_DSN: ${VITE_SENTRY_DSN:-}
      VITE_SENTRY_ENVIRONMENT: ${NODE_ENV:-development}
    ports:
      - "${FRONTEND_PORT:-5173}:5173"
    volumes:
      # Hot-reload: mount source code
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      # Prevent node_modules override
      - /app/node_modules
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5173 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    networks:
      - etp-network

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  postgres_data:
    driver: local
    name: etp-postgres-data

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  etp-network:
    driver: bridge
    name: etp-network
