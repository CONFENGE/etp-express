# =============================================================================
# Cleanup OLD Secrets Workflow
# ETP Express Project
# =============================================================================
#
# Removes OLD secrets after dual-key transition period.
# Should be run manually 48h after secret rotation.
#
# =============================================================================

name: Cleanup OLD Secrets

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "CONFIRM" to proceed with cleanup'
        required: true
        type: string
      secrets_to_cleanup:
        description: 'Secrets to cleanup'
        required: true
        type: choice
        options:
          - all
          - JWT_SECRET_OLD
          - SESSION_SECRET_OLD

permissions:
  contents: read
  issues: write

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}

    steps:
      - name: Validate confirmation
        id: check
        run: |
          if [ "${{ inputs.confirm }}" != "CONFIRM" ]; then
            echo "::error::You must type 'CONFIRM' to proceed with cleanup"
            echo "proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "proceed=true" >> $GITHUB_OUTPUT

  cleanup:
    needs: validate
    if: needs.validate.outputs.proceed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Determine secrets to cleanup
        id: determine
        run: |
          if [ "${{ inputs.secrets_to_cleanup }}" == "all" ]; then
            echo "secrets=JWT_SECRET_OLD,SESSION_SECRET_OLD" >> $GITHUB_OUTPUT
          else
            echo "secrets=${{ inputs.secrets_to_cleanup }}" >> $GITHUB_OUTPUT
          fi

      - name: Delete OLD secrets from Railway
        run: |
          secrets_list="${{ steps.determine.outputs.secrets }}"
          deleted=""

          for secret in ${secrets_list//,/ }; do
            echo "Deleting $secret..."

            response=$(curl -s --request POST \
              --url https://backboard.railway.app/graphql/v2 \
              --header "Authorization: Bearer ${{ secrets.RAILWAY_API_TOKEN }}" \
              --header "Content-Type: application/json" \
              --data "{
                \"query\": \"mutation { variableDelete(input: { projectId: \\\"${{ secrets.RAILWAY_PROJECT_ID }}\\\", environmentId: \\\"${{ secrets.RAILWAY_ENVIRONMENT_ID }}\\\", serviceId: \\\"${{ secrets.RAILWAY_SERVICE_ID }}\\\", name: \\\"${secret}\\\" }) }\"
              }")

            if echo "$response" | jq -e '.errors' > /dev/null 2>&1; then
              error_msg=$(echo "$response" | jq -r '.errors[0].message // "Unknown error"')
              echo "::warning::Failed to delete $secret: $error_msg"
            else
              echo "Successfully deleted $secret"
              deleted="${deleted}${secret},"
            fi
          done

          echo "Deleted secrets: ${deleted%,}"

      - name: Create cleanup audit issue
        uses: actions/github-script@v7
        with:
          script: |
            const secrets = '${{ steps.determine.outputs.secrets }}'.split(',');
            const date = new Date().toISOString().split('T')[0];

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Audit] OLD secrets cleanup completed - ${date}`,
              body: `## OLD Secrets Cleanup

            **Date:** ${date}
            **Secrets Removed:**
            ${secrets.map(s => `- [x] ${s}`).join('\n')}

            Dual-key rotation period completed. System now uses only the new secrets.

            ---
            *Automated cleanup by GitHub Actions*
            `,
              labels: ['security', 'audit', 'automated']
            });
