name: Secret Scanning

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["master", "main"]
  schedule:
    # Run daily at 3 AM UTC to catch any secrets
    - cron: "0 3 * * *"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  gitleaks:
    name: Scan for Secrets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for comprehensive scan

      - name: Run Gitleaks
        id: gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml
          GITLEAKS_ENABLE_UPLOAD_ARTIFACT: true
          GITLEAKS_ENABLE_SUMMARY: true

      - name: Upload Gitleaks Report
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: gitleaks-report
          path: gitleaks-report.json
          retention-days: 30

      - name: Comment on PR (if secrets found)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ⚠️ Secrets Detected!

            Gitleaks found potential secrets in this PR.

            **Action Required:**
            1. Review the Gitleaks report in the workflow artifacts
            2. Remove any secrets from the code
            3. If false positive, update \`.gitleaks.toml\`
            4. Push the fixes to this branch

            **Security Best Practices:**
            - Never commit API keys, passwords, or tokens
            - Use environment variables for secrets
            - Use secret management services (Railway Secrets, AWS Secrets Manager, etc.)
            - Rotate any leaked credentials immediately

            See \`docs/SECURITY.md\` for detailed procedures.`
            })

      - name: Fail if secrets found
        if: steps.gitleaks.outcome == 'failure'
        run: |
          echo "❌ Secrets detected! See the Gitleaks report above."
          echo "Remove secrets and update .gitleaks.toml if needed."
          exit 1
