name: Secret Scanning

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  schedule:
    # Run weekly (Monday) at 3 AM UTC to catch any secrets
    - cron: '0 3 * * 1'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  pull-requests: write
  security-events: write

jobs:
  gitleaks:
    name: Scan for Secrets
    runs-on:
      group: confenge-runners
      labels: ubuntu-16core

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for comprehensive scan

      - name: Install Gitleaks
        run: |
          GITLEAKS_VERSION=$(curl -s "https://api.github.com/repos/gitleaks/gitleaks/releases/latest" | grep -Po '"tag_name": "v\K[0-9.]+')
          echo "Installing Gitleaks v${GITLEAKS_VERSION}"
          wget -qO gitleaks.tar.gz "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz"
          tar xzf gitleaks.tar.gz gitleaks
          chmod +x gitleaks
          ./gitleaks version

      - name: Determine scan mode
        id: scan-mode
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "Scanning PR commits only (incremental)"
            echo "log-opts=--log-opts=origin/${{ github.base_ref }}..${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "Scanning full repository"
            echo "log-opts=" >> $GITHUB_OUTPUT
          fi

      - name: Run Gitleaks
        id: gitleaks
        run: |
          if [ -f ".gitleaks.toml" ]; then
            CONFIG_FLAG="--config .gitleaks.toml"
          else
            CONFIG_FLAG=""
          fi

          ./gitleaks detect \
            --source . \
            $CONFIG_FLAG \
            --report-format sarif \
            --report-path gitleaks-report.sarif \
            ${{ steps.scan-mode.outputs.log-opts }} \
            --exit-code 0 || echo "gitleaks_exit_code=$?" >> $GITHUB_OUTPUT

          # Check if secrets were found
          if [ -f gitleaks-report.sarif ]; then
            FINDINGS=$(cat gitleaks-report.sarif | jq '.runs[0].results | length')
            echo "findings=$FINDINGS" >> $GITHUB_OUTPUT
            if [ "$FINDINGS" -gt 0 ]; then
              echo "secrets_found=true" >> $GITHUB_OUTPUT
              echo "::error::Gitleaks found $FINDINGS potential secret(s)!"
            else
              echo "secrets_found=false" >> $GITHUB_OUTPUT
              echo "No secrets detected."
            fi
          else
            echo "secrets_found=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks-report.sarif
        continue-on-error: true

      - name: Upload Gitleaks Report
        if: steps.gitleaks.outputs.secrets_found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: gitleaks-report.sarif
          retention-days: 30

      - name: Comment on PR (if secrets found)
        if: steps.gitleaks.outputs.secrets_found == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## :warning: Secrets Detected!

            Gitleaks found potential secrets in this PR.

            **Action Required:**
            1. Review the Gitleaks report in the workflow artifacts
            2. Remove any secrets from the code
            3. If false positive, update \`.gitleaks.toml\`
            4. Push the fixes to this branch

            **Security Best Practices:**
            - Never commit API keys, passwords, or tokens
            - Use environment variables for secrets
            - Use secret management services (Railway Secrets, AWS Secrets Manager, etc.)
            - Rotate any leaked credentials immediately

            See \`docs/SECURITY.md\` for detailed procedures.`
            })

      - name: Fail if secrets found
        if: steps.gitleaks.outputs.secrets_found == 'true'
        run: |
          echo "::error::Secrets detected! See the Gitleaks report above."
          echo "Remove secrets and update .gitleaks.toml if needed."
          exit 1
