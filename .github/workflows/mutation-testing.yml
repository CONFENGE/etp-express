name: Mutation Testing (Stryker)

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target to run mutation testing on'
        required: true
        default: 'both'
        type: choice
        options:
          - backend
          - frontend
          - both
      incremental:
        description: 'Use incremental mode (faster, uses cache)'
        required: false
        default: true
        type: boolean
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'

concurrency:
  group: mutation-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'

jobs:
  mutation-backend:
    name: Backend Mutation Testing
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.target == 'backend' || github.event.inputs.target == 'both' || github.event_name == 'schedule' }}

    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Restore Stryker cache
        if: ${{ github.event.inputs.incremental != 'false' }}
        uses: actions/cache@v4
        with:
          path: backend/.stryker-cache
          key: stryker-backend-${{ runner.os }}-${{ hashFiles('backend/src/**/*.ts') }}
          restore-keys: |
            stryker-backend-${{ runner.os }}-

      - name: Run mutation testing
        run: npm run test:mutation
        env:
          CI: true
          STRYKER_INCREMENTAL: ${{ github.event.inputs.incremental }}

      - name: Upload mutation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-report-backend
          path: backend/reports/mutation/
          retention-days: 30

  mutation-frontend:
    name: Frontend Mutation Testing
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.target == 'frontend' || github.event.inputs.target == 'both' || github.event_name == 'schedule' }}

    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Restore Stryker cache
        if: ${{ github.event.inputs.incremental != 'false' }}
        uses: actions/cache@v4
        with:
          path: frontend/.stryker-cache
          key: stryker-frontend-${{ runner.os }}-${{ hashFiles('frontend/src/**/*.ts', 'frontend/src/**/*.tsx') }}
          restore-keys: |
            stryker-frontend-${{ runner.os }}-

      - name: Run mutation testing
        run: npm run test:mutation
        env:
          CI: true
          STRYKER_INCREMENTAL: ${{ github.event.inputs.incremental }}

      - name: Upload mutation report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-report-frontend
          path: frontend/reports/mutation/
          retention-days: 30

  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [mutation-backend, mutation-frontend]
    if: always()

    steps:
      - name: Download backend report
        uses: actions/download-artifact@v4
        with:
          name: mutation-report-backend
          path: reports/backend
        continue-on-error: true

      - name: Download frontend report
        uses: actions/download-artifact@v4
        with:
          name: mutation-report-frontend
          path: reports/frontend
        continue-on-error: true

      - name: Generate summary
        run: |
          echo "## Mutation Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f reports/backend/mutation.html ]; then
            echo "### Backend" >> $GITHUB_STEP_SUMMARY
            echo "Mutation report generated. Download artifact for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Backend" >> $GITHUB_STEP_SUMMARY
            echo "No report generated or job skipped." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f reports/frontend/mutation.html ]; then
            echo "### Frontend" >> $GITHUB_STEP_SUMMARY
            echo "Mutation report generated. Download artifact for details." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Frontend" >> $GITHUB_STEP_SUMMARY
            echo "No report generated or job skipped." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Goal: Mutation score > 60% for critical modules*" >> $GITHUB_STEP_SUMMARY
