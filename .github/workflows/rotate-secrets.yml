# =============================================================================
# Secret Rotation Workflow
# ETP Express Project
# =============================================================================
#
# Automated monthly rotation of JWT_SECRET and SESSION_SECRET.
# Uses Railway GraphQL API for zero-downtime dual-key rotation.
#
# Required GitHub Secrets:
#   - RAILWAY_API_TOKEN: Railway API token (Team Settings > Tokens)
#   - RAILWAY_PROJECT_ID: Railway project ID
#   - RAILWAY_ENVIRONMENT_ID: Production environment ID
#   - RAILWAY_SERVICE_ID: Backend service ID
#   - SLACK_WEBHOOK_URL: (Optional) For failure notifications
#
# Schedule: First day of each month at 2h UTC
# Manual: Use workflow_dispatch to run on-demand
#
# =============================================================================

name: Rotate Secrets

on:
  schedule:
    # First day of each month at 02:00 UTC
    - cron: '0 2 1 * *'
  workflow_dispatch:
    inputs:
      secret_name:
        description: 'Secret to rotate'
        required: true
        type: choice
        options:
          - all
          - JWT_SECRET
          - SESSION_SECRET
      dry_run:
        description: 'Dry run (generate but do not apply)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read
  issues: write

env:
  PRODUCTION_URL: https://etp-express-backend.railway.app
  HEALTH_ENDPOINT: /api/health
  DUAL_KEY_PERIOD_HOURS: 48

jobs:
  rotate:
    runs-on: ubuntu-latest
    outputs:
      rotated_secrets: ${{ steps.rotate.outputs.rotated_secrets }}
      rotation_date: ${{ steps.rotate.outputs.rotation_date }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required secrets
        run: |
          missing_secrets=""

          if [ -z "${{ secrets.RAILWAY_API_TOKEN }}" ]; then
            missing_secrets="${missing_secrets}RAILWAY_API_TOKEN "
          fi
          if [ -z "${{ secrets.RAILWAY_PROJECT_ID }}" ]; then
            missing_secrets="${missing_secrets}RAILWAY_PROJECT_ID "
          fi
          if [ -z "${{ secrets.RAILWAY_ENVIRONMENT_ID }}" ]; then
            missing_secrets="${missing_secrets}RAILWAY_ENVIRONMENT_ID "
          fi
          if [ -z "${{ secrets.RAILWAY_SERVICE_ID }}" ]; then
            missing_secrets="${missing_secrets}RAILWAY_SERVICE_ID "
          fi

          if [ -n "$missing_secrets" ]; then
            echo "::error::Missing required secrets: $missing_secrets"
            echo "Please configure these secrets in GitHub repository settings."
            exit 1
          fi

          echo "All required secrets are configured."

      - name: Determine secrets to rotate
        id: determine
        run: |
          if [ "${{ github.event_name }}" == "schedule" ] || [ "${{ inputs.secret_name }}" == "all" ]; then
            echo "secrets_to_rotate=JWT_SECRET,SESSION_SECRET" >> $GITHUB_OUTPUT
          else
            echo "secrets_to_rotate=${{ inputs.secret_name }}" >> $GITHUB_OUTPUT
          fi
          echo "Secrets to rotate: $(cat $GITHUB_OUTPUT | grep secrets_to_rotate)"

      - name: Generate new secrets
        id: generate
        run: |
          secrets_list="${{ steps.determine.outputs.secrets_to_rotate }}"
          generated_output=""

          for secret in ${secrets_list//,/ }; do
            new_value=$(openssl rand -base64 64 | tr -d '\n' | head -c 64)

            # Store in environment file (masked in logs)
            echo "::add-mask::$new_value"
            echo "${secret}_NEW=$new_value" >> $GITHUB_ENV

            generated_output="${generated_output}${secret},"
            echo "Generated new value for $secret"
          done

          echo "generated_secrets=${generated_output%,}" >> $GITHUB_OUTPUT

      - name: Get current secret values (for dual-key)
        id: get_current
        run: |
          secrets_list="${{ steps.determine.outputs.secrets_to_rotate }}"

          for secret in ${secrets_list//,/ }; do
            # Query current value from Railway
            response=$(curl -s --request POST \
              --url https://backboard.railway.app/graphql/v2 \
              --header "Authorization: Bearer ${{ secrets.RAILWAY_API_TOKEN }}" \
              --header "Content-Type: application/json" \
              --data "{
                \"query\": \"query { variables(projectId: \\\"${{ secrets.RAILWAY_PROJECT_ID }}\\\", environmentId: \\\"${{ secrets.RAILWAY_ENVIRONMENT_ID }}\\\", serviceId: \\\"${{ secrets.RAILWAY_SERVICE_ID }}\\\") }\"
              }")

            # Extract current value (masked)
            current_value=$(echo "$response" | jq -r ".data.variables.${secret} // empty")

            if [ -n "$current_value" ]; then
              echo "::add-mask::$current_value"
              echo "${secret}_OLD=$current_value" >> $GITHUB_ENV
              echo "Retrieved current $secret for dual-key rotation"
            else
              echo "::warning::Could not retrieve current $secret value"
            fi
          done

      - name: Apply dual-key rotation (Phase 1)
        id: rotate
        if: ${{ inputs.dry_run != true }}
        run: |
          secrets_list="${{ steps.determine.outputs.secrets_to_rotate }}"
          rotated=""
          errors=""

          for secret in ${secrets_list//,/ }; do
            new_value_var="${secret}_NEW"
            old_value_var="${secret}_OLD"
            new_value="${!new_value_var}"
            old_value="${!old_value_var}"

            echo "Rotating $secret..."

            # Step 1: Set OLD secret (for dual-key period)
            if [ -n "$old_value" ]; then
              old_response=$(curl -s --request POST \
                --url https://backboard.railway.app/graphql/v2 \
                --header "Authorization: Bearer ${{ secrets.RAILWAY_API_TOKEN }}" \
                --header "Content-Type: application/json" \
                --data "{
                  \"query\": \"mutation { variableUpsert(input: { projectId: \\\"${{ secrets.RAILWAY_PROJECT_ID }}\\\", environmentId: \\\"${{ secrets.RAILWAY_ENVIRONMENT_ID }}\\\", serviceId: \\\"${{ secrets.RAILWAY_SERVICE_ID }}\\\", name: \\\"${secret}_OLD\\\", value: \\\"${old_value}\\\" }) }\"
                }")

              if echo "$old_response" | jq -e '.errors' > /dev/null 2>&1; then
                echo "::warning::Failed to set ${secret}_OLD: $(echo "$old_response" | jq -r '.errors[0].message // "Unknown error"')"
              else
                echo "Set ${secret}_OLD for dual-key period"
              fi
            fi

            # Step 2: Set NEW secret
            new_response=$(curl -s --request POST \
              --url https://backboard.railway.app/graphql/v2 \
              --header "Authorization: Bearer ${{ secrets.RAILWAY_API_TOKEN }}" \
              --header "Content-Type: application/json" \
              --data "{
                \"query\": \"mutation { variableUpsert(input: { projectId: \\\"${{ secrets.RAILWAY_PROJECT_ID }}\\\", environmentId: \\\"${{ secrets.RAILWAY_ENVIRONMENT_ID }}\\\", serviceId: \\\"${{ secrets.RAILWAY_SERVICE_ID }}\\\", name: \\\"${secret}\\\", value: \\\"${new_value}\\\" }) }\"
              }")

            if echo "$new_response" | jq -e '.errors' > /dev/null 2>&1; then
              error_msg=$(echo "$new_response" | jq -r '.errors[0].message // "Unknown error"')
              echo "::error::Failed to rotate $secret: $error_msg"
              errors="${errors}${secret}: ${error_msg}\n"
            else
              echo "Successfully rotated $secret"
              rotated="${rotated}${secret},"
            fi
          done

          echo "rotated_secrets=${rotated%,}" >> $GITHUB_OUTPUT
          echo "rotation_date=$(date -u +%Y-%m-%d)" >> $GITHUB_OUTPUT

          if [ -n "$errors" ]; then
            echo "::error::Some rotations failed"
            echo "errors=$errors" >> $GITHUB_OUTPUT
          fi

      - name: Dry run summary
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "## Dry Run Summary"
          echo ""
          echo "Secrets that would be rotated:"
          echo "${{ steps.determine.outputs.secrets_to_rotate }}" | tr ',' '\n' | while read secret; do
            echo "  - $secret"
          done
          echo ""
          echo "New values were generated but NOT applied."
          echo "Run without dry_run to apply changes."

  validate:
    needs: rotate
    if: ${{ inputs.dry_run != true }}
    runs-on: ubuntu-latest

    steps:
      - name: Wait for Railway deployment
        run: |
          echo "Waiting 90 seconds for Railway to redeploy..."
          sleep 90

      - name: Validate health endpoint
        id: health
        run: |
          max_attempts=5
          attempt=1

          while [ $attempt -le $max_attempts ]; do
            echo "Health check attempt $attempt of $max_attempts..."

            response=$(curl -s -w "\n%{http_code}" "${{ env.PRODUCTION_URL }}${{ env.HEALTH_ENDPOINT }}" || echo "000")
            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')

            if [ "$http_code" == "200" ]; then
              echo "Health check passed!"
              echo "status=healthy" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "Health check failed with HTTP $http_code"
            attempt=$((attempt + 1))
            sleep 30
          done

          echo "::error::Health check failed after $max_attempts attempts"
          echo "status=unhealthy" >> $GITHUB_OUTPUT
          exit 1

      - name: Validate authentication
        if: steps.health.outputs.status == 'healthy'
        run: |
          # Verify auth endpoints are responding (without actual login)
          auth_response=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST "${{ env.PRODUCTION_URL }}/api/auth/login" \
            -H "Content-Type: application/json" \
            -d '{"email":"test@test.com","password":"invalid"}')

          # Expect 401 (unauthorized) - this means auth is working
          if [ "$auth_response" == "401" ] || [ "$auth_response" == "400" ]; then
            echo "Authentication endpoint responding correctly (HTTP $auth_response)"
          else
            echo "::warning::Unexpected auth response: HTTP $auth_response"
          fi

  audit:
    needs: [rotate, validate]
    if: ${{ always() && inputs.dry_run != true }}
    runs-on: ubuntu-latest

    steps:
      - name: Create audit issue
        uses: actions/github-script@v7
        with:
          script: |
            const rotatedSecrets = '${{ needs.rotate.outputs.rotated_secrets }}' || 'None';
            const rotationDate = '${{ needs.rotate.outputs.rotation_date }}' || new Date().toISOString().split('T')[0];
            const validationStatus = '${{ needs.validate.result }}' === 'success' ? 'PASSED' : 'FAILED';

            const nextRotationDate = new Date();
            nextRotationDate.setMonth(nextRotationDate.getMonth() + 1);
            const nextRotation = nextRotationDate.toISOString().split('T')[0];

            const body = `## Secret Rotation Audit Report

            **Date:** ${rotationDate}
            **Trigger:** ${context.eventName === 'schedule' ? 'Scheduled (monthly)' : 'Manual'}
            **Validation:** ${validationStatus}

            ### Secrets Rotated
            ${rotatedSecrets.split(',').map(s => `- [x] ${s}`).join('\n')}

            ### Dual-Key Status
            The following OLD secrets are active for ${process.env.DUAL_KEY_PERIOD_HOURS}h transition period:
            ${rotatedSecrets.split(',').map(s => `- ${s}_OLD`).join('\n')}

            **Action Required:** Remove OLD secrets after ${process.env.DUAL_KEY_PERIOD_HOURS}h (${new Date(Date.now() + parseInt(process.env.DUAL_KEY_PERIOD_HOURS) * 3600000).toISOString()})

            ### Validation Results
            - Health Check: ${validationStatus}
            - Auth Endpoint: Responding

            ### Next Scheduled Rotation
            **${nextRotation}** (first day of next month)

            ### Checklist
            - [ ] Verify no authentication errors in Sentry
            - [ ] Confirm users can log in
            - [ ] Remove OLD secrets after transition period
            - [ ] Update docs/SECRET_ROTATION_PROCEDURES.md

            ---
            *Automated rotation by GitHub Actions*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Audit] Secret rotation completed - ${rotationDate}`,
              body: body,
              labels: ['security', 'audit', 'automated']
            });

  cleanup-old-secrets:
    needs: [rotate, validate]
    if: ${{ needs.validate.result == 'success' && inputs.dry_run != true }}
    runs-on: ubuntu-latest

    steps:
      - name: Schedule OLD secret cleanup
        run: |
          echo "OLD secrets will remain active for dual-key period."
          echo "A reminder issue has been created for manual cleanup."
          echo ""
          echo "To remove OLD secrets after ${DUAL_KEY_PERIOD_HOURS}h:"
          echo "1. Go to Railway Dashboard"
          echo "2. Delete JWT_SECRET_OLD and SESSION_SECRET_OLD"
          echo "3. Or use Railway GraphQL API variableDelete mutation"

  notify-failure:
    needs: [rotate, validate]
    if: ${{ failure() }}
    runs-on: ubuntu-latest

    steps:
      - name: Send Slack notification
        if: ${{ secrets.SLACK_WEBHOOK_URL != '' }}
        run: |
          curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d '{
              "text": ":warning: *Secret Rotation Failed*",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":warning: *Secret Rotation Failed*\n\nThe automated secret rotation workflow encountered an error.\n\n*Repository:* ${{ github.repository }}\n*Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Workflow>\n\n*Action Required:* Manual intervention needed."
                  }
                }
              ]
            }'

      - name: Create failure issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[URGENT] Secret rotation failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## Secret Rotation Failure

            **Date:** ${new Date().toISOString()}
            **Workflow Run:** [View Details](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})

            ### Immediate Actions Required

            1. **Check workflow logs** for error details
            2. **Verify Railway API token** is valid
            3. **Manual rotation** may be required using \`scripts/rotate-secret.sh\`
            4. **Monitor Sentry** for authentication errors

            ### Escalation

            If not resolved within 1 hour, escalate to team lead.

            ---
            *Automated alert by GitHub Actions*
            `,
              labels: ['security', 'incident', 'priority/P0']
            });
