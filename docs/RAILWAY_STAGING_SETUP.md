# Railway Staging Environment Setup Guide

**Issue:** #1191 - [E2E] Create dedicated staging environment for E2E tests

This guide documents how to set up a dedicated staging environment on Railway for E2E testing.

---

## Problem Statement

E2E tests currently run against **Railway production**, causing:

1. **Rate Limiting** (#1186) - Production throttles rapid test requests
2. **Data Pollution** - Tests create/modify real production data
3. **401 Errors** (#1187) - Auth state conflicts with real users
4. **High Latency** - Network round-trips slow down tests

## Architecture

### Before (Issues)
```
GitHub Actions → Railway Production (same as real users)
                      ↓
                 Shared Database
                 Shared Rate Limits
                 Shared Auth Sessions
```

### After (Isolated)
```
GitHub Actions → Railway Staging (isolated)
                      ↓
                 Dedicated E2E Database
                 Relaxed Rate Limits
                 Test-only Auth Sessions
```

---

## Setup Instructions

### 1. Create Staging Services on Railway

#### Backend Service

1. Go to Railway Dashboard: https://railway.app/dashboard
2. Create new service: **etp-express-backend-staging**
3. Link to same GitHub repo: `CONFENGE/etp-express`
4. Set branch: `master` (or create dedicated `staging` branch)
5. Set root directory: `/backend`

#### Frontend Service (Optional but recommended)

1. Create new service: **etp-express-frontend-staging**
2. Link to same GitHub repo: `CONFENGE/etp-express`
3. Set branch: `master`
4. Set root directory: `/frontend`

#### Database Service

1. Create new PostgreSQL database: **etp-express-db-staging**
2. Link to backend staging service
3. Railway will auto-generate `DATABASE_URL` variable

---

### 2. Configure Environment Variables

In **etp-express-backend-staging** service, set:

#### Core Configuration
```bash
NODE_ENV=staging
PORT=3001
```

#### Rate Limiting (Disabled for E2E tests)
```bash
RATE_LIMIT_ENABLED=false
```

Or, if you prefer explicit relaxed limits:
```bash
RATE_LIMIT_ENABLED=true
RATE_LIMIT_TTL=3600
RATE_LIMIT_MAX=10000
```

#### CORS Configuration
```bash
CORS_ORIGINS=https://etp-express-frontend-staging.up.railway.app,http://localhost:5173
```

#### Database
```bash
DATABASE_URL=<auto-generated-by-railway-postgres>
DB_POOL_MAX=20
DB_POOL_MIN=5
DB_MIGRATIONS_RUN=true
DB_SYNCHRONIZE=false
```

#### JWT & Security
```bash
JWT_SECRET=<generate-new-secret-for-staging>
JWT_EXPIRATION=7d
```

Generate new JWT secret:
```bash
openssl rand -hex 32
```

#### AI Services (Use separate keys if available)
```bash
OPENAI_API_KEY=<staging-key-or-production-key>
OPENAI_MODEL=gpt-4o-mini
EXA_API_KEY=<staging-key-or-production-key>
```

#### Frontend URL
```bash
FRONTEND_URL=https://etp-express-frontend-staging.up.railway.app
```

#### Redis (Optional - Create dedicated Redis or share with production)
```bash
REDIS_URL=<staging-redis-url>
```

---

### 3. Seed Test Users

After first deploy, manually seed test users via Railway console:

```bash
# Connect to staging backend
railway run npm run seed:users:staging --workspace=etp-express-backend
```

Or create seed script in `backend/src/seeds/test-users.seed.ts`:

```typescript
import { UserRole } from '../modules/users/enums/user-role.enum';

export const TEST_USERS = [
  {
    email: 'admin@etp-staging.test',
    password: 'Test@1234',
    role: UserRole.ADMIN,
    name: 'Admin Test User',
  },
  {
    email: 'demo@etp-staging.test',
    password: 'Test@1234',
    role: UserRole.DEMO_USER,
    name: 'Demo Test User',
  },
  {
    email: 'manager@etp-staging.test',
    password: 'Test@1234',
    role: UserRole.MANAGER,
    name: 'Manager Test User',
  },
  {
    email: 'user@etp-staging.test',
    password: 'Test@1234',
    role: UserRole.USER,
    name: 'User Test User',
  },
  {
    email: 'system-admin@etp-staging.test',
    password: 'Test@1234',
    role: UserRole.SYSTEM_ADMIN,
    name: 'System Admin Test User',
  },
];
```

---

### 4. Update GitHub Secrets

Add new secrets for staging credentials:

1. Go to: https://github.com/CONFENGE/etp-express/settings/secrets/actions
2. Add secrets:

```bash
E2E_BASE_URL_STAGING=https://etp-express-frontend-staging.up.railway.app
E2E_API_URL_STAGING=https://etp-express-backend-staging.up.railway.app

# Staging-specific credentials (different from production)
E2E_ADMIN_EMAIL_STAGING=admin@etp-staging.test
E2E_ADMIN_PASSWORD_STAGING=Test@1234
E2E_DEMO_EMAIL_STAGING=demo@etp-staging.test
E2E_DEMO_PASSWORD_STAGING=Test@1234
E2E_MANAGER_EMAIL_STAGING=manager@etp-staging.test
E2E_MANAGER_PASSWORD_STAGING=Test@1234
E2E_SYSTEM_ADMIN_EMAIL_STAGING=system-admin@etp-staging.test
E2E_SYSTEM_ADMIN_PASSWORD_STAGING=Test@1234
E2E_USER_EMAIL_STAGING=user@etp-staging.test
E2E_USER_PASSWORD_STAGING=Test@1234
```

---

### 5. Update CI/CD Workflows

See changes in `.github/workflows/playwright.yml`:

- E2E tests now use `E2E_BASE_URL_STAGING` and `E2E_API_URL_STAGING`
- Rate limiting disabled on staging (no 429 errors)
- Isolated database (tests don't affect production)

---

## Validation Checklist

After setup, validate:

- [ ] Staging backend accessible: `https://etp-express-backend-staging.up.railway.app/api/health`
- [ ] Staging frontend accessible: `https://etp-express-frontend-staging.up.railway.app`
- [ ] Database migrations ran successfully (check Railway logs)
- [ ] Test users seeded successfully
- [ ] Rate limiting disabled (check backend logs: "Rate limiting: DISABLED")
- [ ] GitHub Actions E2E tests pass without 429/401 errors
- [ ] Swagger docs accessible at: `https://etp-express-backend-staging.up.railway.app/api/docs`

---

## Cost Analysis

**Estimated Monthly Cost:**

| Resource | Production | Staging | Delta |
|----------|------------|---------|-------|
| Backend Compute | $10/mo | $10/mo | +$10 |
| Frontend Compute | $10/mo | $10/mo | +$10 |
| PostgreSQL Starter | $5/mo | $5/mo | +$5 |
| Redis (Optional) | $5/mo | $5/mo | +$5 |
| **Total** | **$30/mo** | **$30/mo** | **+$30/mo** |

**Note:** Costs are estimates. Railway charges based on actual usage.

**Optimization:** If cost is a concern, staging can share Redis with production (different DB index).

---

## Maintenance

### Database Reset (Monthly or per-PR)

To reset staging database to clean state:

```bash
# Connect to staging service
railway run npm run migration:revert --workspace=etp-express-backend
railway run npm run migration:run --workspace=etp-express-backend
railway run npm run seed:templates --workspace=etp-express-backend
railway run npm run seed:users:staging --workspace=etp-express-backend
```

Or via Railway dashboard:
1. Delete `etp-express-db-staging` database
2. Create new PostgreSQL database
3. Link to backend staging
4. Redeploy backend staging (auto-runs migrations)

### Monitor Staging Health

- Check Railway logs regularly for errors
- Monitor E2E test pass rate in GitHub Actions
- Validate rate limiting is disabled (no 429 errors)

---

## Troubleshooting

### E2E Tests Still Getting 429 Errors

**Check:**
1. Workflow is using `E2E_API_URL_STAGING` (not production URL)
2. Backend staging has `RATE_LIMIT_ENABLED=false`
3. Backend logs show: "Rate limiting: DISABLED"

### Database Connection Errors

**Check:**
1. `DATABASE_URL` is set in staging backend env vars
2. PostgreSQL staging service is running
3. Backend staging has network access to database

### Auth Errors (401)

**Check:**
1. Test users were seeded correctly
2. JWT_SECRET is set in staging backend
3. Frontend staging is using correct backend staging URL

### Staging URLs Not Resolving

**Check:**
1. Both frontend and backend staging services are deployed
2. Railway generated public URLs (check service settings)
3. Services are not sleeping (Railway free tier sleeps after inactivity)

---

## References

- **Issue:** #1191 - [E2E] Create dedicated staging environment
- **Related Issues:**
  - #1186 - Rate limiting causing 429 errors
  - #1187 - Persistent 401 errors in E2E tests
  - #1137 - Epic: Fix all 73 failing E2E tests
- **Railway Docs:** https://docs.railway.app/
- **Architecture:** [ARCHITECTURE.md](../ARCHITECTURE.md)

---

## Next Steps

After staging is set up:

1. Run E2E tests manually to validate setup
2. Fix remaining E2E test failures (#1137)
3. Optimize CI/CD pipeline (#1190 - reduce 90min → 20min)
4. Consider adding nightly full E2E runs with AI tests

---

**Last Updated:** 2026-01-15
**Status:** ✅ Implemented (Issue #1191)
