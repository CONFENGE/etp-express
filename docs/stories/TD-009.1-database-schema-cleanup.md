# Story TD-009.1: Database Schema Cleanup

## Metadata
| Campo | Valor |
|-------|-------|
| **Parent Story** | TD-009 (Code Quality - Schema Cleanup & System Hygiene) |
| **Priority** | P3 |
| **Estimated Effort** | 6h |
| **Area** | Database / Backend |
| **Debts Addressed** | DB-05, DB-06, DB-07 |
| **Dependencies** | None |
| **Blocked By** | None |
| **Status** | ✅ Done (Completed: 2026-02-13) |

---

## Description

Como equipe de desenvolvimento, quero resolver inconsistencias de schema no banco de dados — campos duplicados, colunas sem tipagem adequada e tipos `any` — para que a base de codigo seja type-safe, auditavel e consistente com as convencoes do projeto.

---

## Technical Debts Addressed

### DB-05: Campos versao/currentVersion duplicados em TermoReferencia (MEDIA - 2h)

**Arquivo:** `backend/src/entities/termo-referencia.entity.ts` (linhas 244-252)

**Problema:** A entidade `TermoReferencia` possui dois campos com semantica identica:
```typescript
@Column({ default: 1 })
versao: number;

@Column({ default: 1 })
currentVersion: number;
```
Ambos inicializam com valor 1 e representam o versionamento do documento. A ambiguidade causa confusao sobre qual campo e a fonte da verdade.

**Resolucao:**
1. Deprecar `versao` — manter `currentVersion` como unica fonte de verdade
2. Criar migration que copia `MAX(versao, currentVersion)` para `currentVersion` onde divergirem
3. Remover coluna `versao` da entidade e do banco (ou marcar como @deprecated com migration futura)
4. Atualizar todos os servicos/controllers que referenciam `versao`

### DB-06: created_by varchar em Etp sem type: 'uuid' (MEDIA - 2h)

**Arquivo:** `backend/src/entities/etp.entity.ts` (linhas 433-440)

**Problema:** O campo `created_by` e definido como `string` no TypeScript sem `type: 'uuid'` no decorator da coluna:
```typescript
@Column({ name: 'created_by' })
createdById: string;
```
Embora o `@ManyToOne` + `@JoinColumn` garanta a FK via ORM, a coluna no banco aceita qualquer string (nao apenas UUIDs validos).

**Resolucao:**
1. Adicionar `type: 'uuid'` ao decorator: `@Column({ name: 'created_by', type: 'uuid' })`
2. Criar migration para alterar o tipo da coluna (`ALTER COLUMN ... TYPE uuid USING created_by::uuid`)
3. Validar que todos os registros existentes possuem UUIDs validos antes da migration

### DB-07: ContratoSyncLog.resolution e ConflictField tipados como `any` (MEDIA - 2h)

**Arquivo:** `backend/src/entities/contrato-sync-log.entity.ts` (linhas 15-22 e 68-76)

**Problema:** Tres campos usam `any`, perdendo type safety:
```typescript
export interface ConflictField {
  field: string;
  localValue: any;  // <- any
  remoteValue: any; // <- any
}

@Column({ type: 'jsonb', nullable: true })
resolution?: any; // <- any
```

**Resolucao:**
1. Criar interface `ContratoResolution` com `Partial<Contrato>` tipado (excluindo relacoes)
2. Tipar `ConflictField.localValue` e `remoteValue` como `string | number | boolean | null | Record<string, unknown>`
3. Tipar `resolution` como `ContratoResolution | null`
4. Atualizar testes e servicos que manipulam esses campos

---

## Acceptance Criteria

- [x] `TermoReferencia.versao` depreciado e removido (ou marcado `@deprecated`)
- [x] `TermoReferencia.currentVersion` e a unica fonte de verdade para versionamento
- [x] Migration criada para unificar dados de `versao` em `currentVersion`
- [x] `Etp.createdById` declarado com `type: 'uuid'` no decorator `@Column`
- [x] Migration criada para alterar tipo da coluna `created_by` para `uuid`
- [x] `ContratoSyncLog.resolution` tipado como `ContratoResolution | null` (nao `any`)
- [x] `ConflictField.localValue` e `.remoteValue` tipados (nao `any`)
- [x] Interfaces `ContratoResolution` e `ConflictFieldValue` criadas e exportadas
- [x] Zero erros de TypeScript apos as mudancas
- [x] Todos os testes existentes passam apos as alteracoes

---

## Test Plan

### Testes Unitarios
- Verificar que `TermoReferencia` nao possui mais campo `versao` (ou que esta @deprecated)
- Verificar que `currentVersion` incrementa corretamente em servicos de versionamento
- Verificar que `Etp.createdById` aceita apenas UUIDs validos
- Verificar que `ContratoSyncLog.resolution` rejeita dados fora do tipo `ContratoResolution`

### Testes de Migration
- Migration de unificacao versao→currentVersion: validar dados antes/depois
- Migration de tipo uuid: validar que registros existentes nao quebram
- Teste de reversibilidade (`down()`) para cada migration

### Testes de Regressao
- Suite completa `npm test` passa sem erros
- Endpoints de TR, ETP e ContratoSync continuam funcionando
- `npm run typecheck` sem erros

---

## Files Affected

| Arquivo | Mudanca |
|---------|---------|
| `backend/src/entities/termo-referencia.entity.ts` | Remover/deprecar `versao`, manter `currentVersion` |
| `backend/src/entities/etp.entity.ts` | Adicionar `type: 'uuid'` em `createdById` |
| `backend/src/entities/contrato-sync-log.entity.ts` | Tipar `resolution`, `ConflictField` |
| `backend/src/migrations/XXXXXXXXX-UnifyTRVersion.ts` | Nova migration |
| `backend/src/migrations/XXXXXXXXX-EtpCreatedByUuid.ts` | Nova migration |
| Servicos que referenciam `versao` em TR | Atualizar para `currentVersion` |
| Servicos que manipulam `ContratoSyncLog.resolution` | Adaptar aos novos tipos |
| Testes unitarios afetados | Atualizar mocks e assertions |

---

*Story criada em 2026-02-12 por @pm (Morgan) - AIOS v3.10.0*
