# Story TD-010.3: Database Convention Fixes

## Metadata
| Campo | Valor |
|-------|-------|
| **Parent Story** | TD-010 (Backlog - Infrastructure & Long-term Improvements) |
| **Priority** | P4 |
| **Estimated Effort** | 7.5h |
| **Area** | Database / Backend |
| **Debts Addressed** | DB-03, DB-08, DB-10, DB-11, DB-NEW-05, DB-S04 |
| **Dependencies** | None |
| **Blocked By** | None |

---

## Description

Como equipe de desenvolvimento, quero padronizar convencoes de banco de dados — PK UUID, entity names explicitos, `updatedAt` em todas as entities, enums declarados, e validacao de CNPJ no banco — para que o schema seja consistente, auditavel e seguro por design.

---

## Technical Debts Addressed

### DB-03: ApiUsage com PK integer (BAIXA - 2h)

**Arquivo:** `backend/src/modules/market-intelligence/entities/api-usage.entity.ts` (linha 32)

**Problema:** Unica entity do sistema com PK auto-increment integer:
```typescript
@PrimaryGeneratedColumn()
id: number;
```
Todas as outras 50+ entities usam UUID. Inconsistencia que dificulta ferramentas e convencoes genericas.

**Resolucao:**
1. Alterar para `@PrimaryGeneratedColumn('uuid')` com tipo `string`
2. Criar migration para:
   - Adicionar coluna `new_id` UUID com default `gen_random_uuid()`
   - Copiar dados: `UPDATE api_usage SET new_id = gen_random_uuid()`
   - Renomear colunas
   - Atualizar FKs se existentes
3. Validar que nenhum servico depende do tipo `number` do id

### DB-08: Falta de UpdateDateColumn em 6 entities (BAIXA - 2h)

**Entities afetadas:**
| Entity | Arquivo | CreateDate | UpdateDate |
|--------|---------|------------|------------|
| EtpVersion | `entities/etp-version.entity.ts` (L42) | Sim | **NAO** |
| Ateste | `entities/ateste.entity.ts` (L147) | Sim | **NAO** |
| DocumentoFiscalizacao | `entities/documento-fiscalizacao.entity.ts` (L173) | Sim | **NAO** |
| ContratoSyncLog | `entities/contrato-sync-log.entity.ts` (L81) | Sim | **NAO** |
| ExportMetadata | `modules/export/entities/export-metadata.entity.ts` (L68) | Sim | **NAO** |
| ApiUsage | `modules/market-intelligence/entities/api-usage.entity.ts` (L51) | Sim | **NAO** |

**Resolucao:**
1. Adicionar `@UpdateDateColumn()` em cada entity
2. Criar migration unica adicionando coluna `updatedAt` com default `now()` em todas as 6 tabelas
3. Backfill: `UPDATE tabela SET "updatedAt" = "createdAt"` para registros existentes

### DB-10: ApiUsage sem entity name explicito (BAIXA - 0.5h)

**Arquivo:** `backend/src/modules/market-intelligence/entities/api-usage.entity.ts` (linha 27)

**Problema:** `@Entity()` sem nome — TypeORM gera nome automaticamente (`apiusage` ou `api_usage` dependendo da config).

**Resolucao:** Alterar para `@Entity('api_usage')` com nome explicito seguindo convencao snake_case.

### DB-11: Enum inline em govBrSyncStatus (BAIXA - 1h)

**Arquivo:** `backend/src/entities/contrato.entity.ts` (linhas 409-414)

**Problema:**
```typescript
@Column({
  type: 'enum',
  enum: ['pending', 'synced', 'error'],
  default: 'pending',
})
govBrSyncStatus: 'pending' | 'synced' | 'error';
```
Enum definido inline sem constante TypeScript declarada. Impede reutilizacao e autocomplete.

**Resolucao:**
1. Criar enum TypeScript:
```typescript
export enum GovBrSyncStatus {
  PENDING = 'pending',
  SYNCED = 'synced',
  ERROR = 'error',
}
```
2. Atualizar entity para usar o enum
3. Atualizar servicos e controllers que referenciam os valores literais

### DB-NEW-05: ExportMetadata.format como enum inline (BAIXA - 0.5h)

**Arquivo:** `backend/src/modules/export/entities/export-metadata.entity.ts` (linha 50)

**Problema:**
```typescript
@Column({ type: 'enum', enum: ['pdf', 'docx', 'json'] })
format: 'pdf' | 'docx' | 'json';
```

**Resolucao:**
1. Criar enum TypeScript:
```typescript
export enum ExportFormat {
  PDF = 'pdf',
  DOCX = 'docx',
  JSON = 'json',
}
```
2. Atualizar entity e servicos

### DB-S04: CNPJ armazenado sem validacao no banco (BAIXA - 1h)

**Arquivo:** `backend/src/entities/contrato.entity.ts` (linhas 136-137)

**Problema:**
```typescript
@Column({ type: 'varchar', length: 18 })
contratadoCnpj: string;
```
CNPJ aceita qualquer string de ate 18 caracteres. Validacao existe apenas na aplicacao.

**Resolucao:**
1. Criar migration com CHECK constraint:
```sql
ALTER TABLE contratos ADD CONSTRAINT chk_contratado_cnpj
  CHECK (contratado_cnpj ~ '^\d{2}\.\d{3}\.\d{3}/\d{4}-\d{2}$'
         OR contratado_cnpj ~ '^\d{14}$');
```
2. Aceitar CNPJ formatado (XX.XXX.XXX/XXXX-XX) e nao formatado (14 digitos)
3. Validar que registros existentes atendem ao padrao antes de aplicar constraint

---

## Acceptance Criteria

- [ ] `ApiUsage.id` alterado para UUID (`@PrimaryGeneratedColumn('uuid')`)
- [ ] Migration de conversao integer→UUID criada e testada
- [ ] `@Entity('api_usage')` com nome explicito adicionado
- [ ] `@UpdateDateColumn()` adicionado em: EtpVersion, Ateste, DocumentoFiscalizacao, ContratoSyncLog, ExportMetadata, ApiUsage
- [ ] Migration unica adicionando `updatedAt` em 6 tabelas com backfill `= createdAt`
- [ ] Enum `GovBrSyncStatus` criado e usado em Contrato entity
- [ ] Enum `ExportFormat` criado e usado em ExportMetadata entity
- [ ] CHECK constraint para CNPJ criado no banco (aceita formato com/sem mascara)
- [ ] Registros existentes validados antes de aplicar CHECK constraint
- [ ] `npm run typecheck` passa sem erros
- [ ] Todos os testes passam

---

## Test Plan

### DB-03 (ApiUsage UUID)
- Criar ApiUsage com novo schema → id e UUID valido
- Servicos que consultam ApiUsage funcionam com tipo string
- Migration reversivel (down) funciona

### DB-08 (updatedAt)
- Atualizar registro → `updatedAt` muda automaticamente
- `createdAt` nao muda ao atualizar
- Registros existentes tem `updatedAt = createdAt` apos backfill

### DB-11 / DB-NEW-05 (Enums)
- Inserir com valor valido do enum → sucesso
- Inserir com valor fora do enum → erro do banco
- Autocomplete funciona nos servicos

### DB-S04 (CNPJ CHECK)
- CNPJ formatado `12.345.678/0001-90` → aceito
- CNPJ sem mascara `12345678000190` → aceito
- String invalida `ABC` → rejeitado pelo banco
- Registros existentes: 100% passam na constraint

---

## Files Affected

| Arquivo | Mudanca |
|---------|---------|
| `backend/src/modules/market-intelligence/entities/api-usage.entity.ts` | UUID PK, entity name, updatedAt |
| `backend/src/entities/etp-version.entity.ts` | Adicionar `@UpdateDateColumn()` |
| `backend/src/entities/ateste.entity.ts` | Adicionar `@UpdateDateColumn()` |
| `backend/src/entities/documento-fiscalizacao.entity.ts` | Adicionar `@UpdateDateColumn()` |
| `backend/src/entities/contrato-sync-log.entity.ts` | Adicionar `@UpdateDateColumn()` |
| `backend/src/modules/export/entities/export-metadata.entity.ts` | Adicionar `@UpdateDateColumn()`, ExportFormat enum |
| `backend/src/entities/contrato.entity.ts` | GovBrSyncStatus enum |
| `backend/src/enums/gov-br-sync-status.enum.ts` | **NOVO** - Enum declarado |
| `backend/src/enums/export-format.enum.ts` | **NOVO** - Enum declarado |
| `backend/src/migrations/XXXXXXXXX-ApiUsageUuid.ts` | Nova migration |
| `backend/src/migrations/XXXXXXXXX-AddUpdatedAt.ts` | Nova migration |
| `backend/src/migrations/XXXXXXXXX-CnpjCheckConstraint.ts` | Nova migration |
| Servicos que usam ApiUsage, govBrSyncStatus, ExportMetadata.format | Atualizar tipos |

---

*Story criada em 2026-02-12 por @pm (Morgan) - AIOS v3.10.0*
