# Story TD-010.6: Monorepo Tooling Evaluation

## Metadata
| Campo | Valor |
|-------|-------|
| **Parent Story** | TD-010 (Backlog - Infrastructure & Long-term Improvements) |
| **Priority** | P4 (Backlog - avaliar quando CI/CD se tornar gargalo) |
| **Estimated Effort** | 16h+ |
| **Area** | Infrastructure / DevOps |
| **Debts Addressed** | SYS-04 |
| **Dependencies** | None |
| **Blocked By** | Prioridade estrategica da equipe |

---

## Description

Como equipe de DevOps, quero avaliar e decidir sobre a adocao de Turborepo ou Nx para orquestrar o monorepo, para que builds, testes e deploys sejam incrementais, cacheados e otimizados — reduzindo tempo de CI e melhorando a DX.

---

## Technical Debt Addressed

### SYS-04: Monorepo sem Turborepo/Nx (ALTA em impacto, mas BAIXA em urgencia - 16h+)

**Arquivo:** `package.json` (raiz, linhas 68-71)

**Configuracao atual:**
```json
{
  "workspaces": ["backend", "frontend"]
}
```

**Problema:** O projeto usa `npm workspaces` basico sem orquestracao de build/test. Consequencias:
- `npm run build` reconstroi tudo sempre (sem cache)
- `npm test` roda todos os testes mesmo quando apenas 1 arquivo mudou
- CI/CD nao aproveita paralelismo
- Nao ha deteccao de dependencias entre workspaces

**Este debito e de avaliacao estrategica**, nao de implementacao imediata. O custo de migracao e alto (16h+) e o beneficio depende do tamanho da equipe e frequencia de CI.

---

## Opcoes de Avaliacao

### Opcao A: Turborepo
| Pro | Contra |
|-----|--------|
| Facil de adotar (minima config) | Ecossistema mais simples |
| Cache local e remoto nativo | Menos features que Nx |
| Suporte a npm workspaces existente | Sem geracao de codigo |
| Zero config para iniciar | Menos mature que Nx |

**Esforco de adocao:** ~8h

### Opcao B: Nx
| Pro | Contra |
|-----|--------|
| Ecossistema maduro e completo | Curva de aprendizado maior |
| Grafos de dependencia avancados | Overhead de configuracao |
| Geracao de codigo (generators) | Pode ser overkill para 2 workspaces |
| Cache remoto (Nx Cloud) | Vendor lock-in parcial |

**Esforco de adocao:** ~16-24h

### Opcao C: Manter npm workspaces + otimizacoes manuais
| Pro | Contra |
|-----|--------|
| Zero custo de migracao | Sem cache incremental |
| Sem dependencia adicional | CI/CD nao otimizado |
| Equipe ja conhece | Builds completos sempre |

**Esforco:** ~2h (scripts de otimizacao)

---

## Acceptance Criteria

### Fase 1: Avaliacao (obrigatoria)
- [ ] Benchmark de CI/CD atual documentado (tempo de build, test, deploy)
- [ ] POC com Turborepo criada em branch experimental
- [ ] POC com Nx criada em branch experimental (se Turborepo insuficiente)
- [ ] Tabela comparativa criada com metricas reais
- [ ] Decisao documentada em ADR (Architecture Decision Record)

### Fase 2: Implementacao (condicional a decisao)
- [ ] Ferramenta escolhida integrada ao monorepo
- [ ] `npm run build` usa cache incremental
- [ ] `npm test` roda apenas testes afetados por mudancas
- [ ] CI/CD pipeline atualizado para usar cache
- [ ] Tempo de CI reduzido em >= 40%
- [ ] Documentacao de uso para equipe

---

## Test Plan

### Fase 1 (Avaliacao)
- Medir tempo de `npm run build` (cold + warm)
- Medir tempo de `npm test` (all + affected)
- Medir tempo de CI pipeline end-to-end
- Comparar metricas entre: npm workspaces, Turborepo, Nx

### Fase 2 (Implementacao)
- Build incremental: mudar 1 arquivo → build recompila apenas workspace afetado
- Cache hit: segundo build identico usa cache (< 5s)
- Testes afetados: mudar arquivo de backend → testes de frontend nao rodam
- CI pipeline: tempo total reduzido em >= 40%

---

## Files Affected

| Arquivo | Mudanca |
|---------|---------|
| `package.json` (raiz) | Adicionar config de Turborepo/Nx |
| `turbo.json` ou `nx.json` | **NOVO** - Configuracao da ferramenta |
| `.github/workflows/` | Atualizar CI para usar cache |
| `docs/architecture/adr-monorepo-tooling.md` | **NOVO** - ADR com decisao |

---

## Criterios de Ativacao

Esta story deve ser priorizada quando:
- Tempo de CI > 10 minutos consistentemente
- Equipe > 3 desenvolvedores trabalhando simultaneamente
- Builds desnecessarios causando gargalo no deploy

---

*Story criada em 2026-02-12 por @pm (Morgan) - AIOS v3.10.0*
