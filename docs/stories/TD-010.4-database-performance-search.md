# Story TD-010.4: Database Performance - Full-Text & Vector Search

## Metadata
| Campo | Valor |
|-------|-------|
| **Parent Story** | TD-010 (Backlog - Infrastructure & Long-term Improvements) |
| **Priority** | P4 |
| **Estimated Effort** | 5h |
| **Area** | Database / Performance |
| **Debts Addressed** | DB-P05, DB-P06 |
| **Dependencies** | None |
| **Blocked By** | None |

---

## Description

Como equipe de performance, quero indexes de busca textual (tsvector) nos campos `objeto` e `descricao`, e index vetorial (IVFFlat) no campo `Legislation.embedding`, para que buscas textuais e semanticas sejam eficientes sem full table scan.

---

## Technical Debts Addressed

### DB-P05: Texto completo sem tsvector (BAIXA - 4h)

**Contexto:** Campos `objeto` e `descricao` sao usados em buscas textuais em varias entities (Etp, TermoReferencia, Edital, Contrato). Atualmente, buscas textuais fazem `ILIKE '%termo%'` que resulta em full table scan.

**Nota:** Ja existem indexes tsvector em tabelas auxiliares:
- `item_categories`: `IDX_item_categories_name_gin` (migration `1768900000000`)
- `sinapi_items` e `sicro_items`: indexes GIN em `description`

**Entidades que precisam de tsvector:**
1. `etps.objeto` — campo principal de busca textual
2. `etps.descricao` — campo secundario
3. `termos_referencia.objeto` — busca por objeto do TR
4. `contratos.objeto` — busca por objeto do contrato
5. `editais.objeto` — busca por objeto do edital

**Resolucao:**
1. Criar migration com colunas `tsvector` geradas:
```sql
-- Coluna tsvector gerada automaticamente
ALTER TABLE etps ADD COLUMN search_vector tsvector
  GENERATED ALWAYS AS (
    to_tsvector('portuguese', coalesce(objeto, '') || ' ' || coalesce(descricao, ''))
  ) STORED;

CREATE INDEX CONCURRENTLY idx_etps_search_vector ON etps USING GIN (search_vector);
```
2. Repetir para termos_referencia, contratos, editais
3. Atualizar servicos para usar `@@` operator ao inves de `ILIKE`
4. Usar dicionario `portuguese` para stemming em PT-BR

### DB-P06: Legislation.embedding sem index vetorial (BAIXA - 1h)

**Arquivo:** `backend/src/entities/legislation.entity.ts` (linhas 79-84)

**Problema:** Campo `embedding` do tipo `vector(1536)` sem index vetorial declarado. Busca de similaridade faz sequential scan.

```typescript
@Column({ type: 'vector', length: 1536, nullable: true })
embedding: number[] | null;
```

**Resolucao:**
1. Criar index IVFFlat (recomendado para < 100K registros):
```sql
CREATE INDEX CONCURRENTLY idx_legislation_embedding_ivfflat
  ON legislation USING ivfflat (embedding vector_cosine_ops)
  WITH (lists = 100);
```
2. Usar IVFFlat (nao HNSW) ate 100K+ registros — menor overhead de memoria
3. Parametro `lists = 100` e adequado para ate 10K registros (ajustar conforme crescimento)

---

## Acceptance Criteria

- [ ] Coluna `search_vector` (tsvector) adicionada em `etps`
- [ ] Coluna `search_vector` (tsvector) adicionada em `termos_referencia`
- [ ] Coluna `search_vector` (tsvector) adicionada em `contratos`
- [ ] Coluna `search_vector` (tsvector) adicionada em `editais`
- [ ] Indexes GIN criados em todas as colunas `search_vector` (CONCURRENTLY)
- [ ] Dicionario `portuguese` usado para stemming PT-BR
- [ ] Servicos de busca textual atualizados para usar `@@` operator
- [ ] Index IVFFlat criado em `legislation.embedding` com `vector_cosine_ops`
- [ ] `EXPLAIN ANALYZE` confirma uso dos novos indexes em queries de busca
- [ ] Performance de busca textual melhorada (medir antes/depois)
- [ ] Todos os testes passam

---

## Test Plan

### DB-P05 (tsvector)
- **Funcional:** Buscar "licitacao" em ETPs → retorna ETPs com "licitacao", "licitacoes", "licitar" (stemming)
- **Performance:** `EXPLAIN ANALYZE` mostra uso do GIN index (nao Seq Scan)
- **Benchmark:** Comparar tempo de busca `ILIKE` vs `@@` com 1K+ registros
- **Edge cases:** Busca com acentos, busca vazia, busca com stopwords

### DB-P06 (IVFFlat)
- **Funcional:** Busca de similaridade vetorial retorna legislacoes relevantes
- **Performance:** `EXPLAIN ANALYZE` mostra uso do IVFFlat index
- **Parametros:** Verificar que `lists = 100` e adequado para volume atual

### Regressao
- Suite completa `npm test` passa
- Endpoints de busca retornam mesmos resultados (com melhor performance)
- Testes E2E de busca funcionam

---

## Files Affected

| Arquivo | Mudanca |
|---------|---------|
| `backend/src/entities/etp.entity.ts` | Adicionar `searchVector` (opcional — gerado no banco) |
| `backend/src/entities/termo-referencia.entity.ts` | Adicionar `searchVector` |
| `backend/src/entities/contrato.entity.ts` | Adicionar `searchVector` |
| `backend/src/entities/edital.entity.ts` | Adicionar `searchVector` |
| `backend/src/migrations/XXXXXXXXX-AddTsvectorColumns.ts` | Nova migration (tsvector + GIN) |
| `backend/src/migrations/XXXXXXXXX-AddLegislationIvfflat.ts` | Nova migration (IVFFlat) |
| Servicos de busca (EtpService, etc.) | Atualizar queries para usar `@@` |
| Testes de busca | Atualizar para validar stemming |

---

## Notas Tecnicas

- **Dicionario `portuguese`:** O PostgreSQL inclui dicionario `portuguese` por padrao. Nao requer extensao adicional.
- **GENERATED ALWAYS AS:** Colunas geradas sao automaticamente atualizadas pelo PostgreSQL quando os campos fonte mudam. Nao requer trigger.
- **IVFFlat vs HNSW:** IVFFlat requer menos memoria e e mais rapido de construir. HNSW so se justifica com 100K+ registros para recall de 99%+.
- **CONCURRENTLY:** Todos os indexes devem usar `CREATE INDEX CONCURRENTLY` para evitar lock em producao.

---

*Story criada em 2026-02-12 por @pm (Morgan) - AIOS v3.10.0*
