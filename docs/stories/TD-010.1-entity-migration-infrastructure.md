# Story TD-010.1: Entity Scan & Migration Infrastructure

## Metadata
| Campo | Valor |
|-------|-------|
| **Parent Story** | TD-010 (Backlog - Infrastructure & Long-term Improvements) |
| **Priority** | P4 |
| **Estimated Effort** | 6-8h |
| **Area** | Backend / Infrastructure |
| **Debts Addressed** | SYS-02, SYS-03 |
| **Dependencies** | None (SYS-03 deve ser o ULTIMO item do epic) |
| **Blocked By** | Todas as outras stories de TD devem estar completas antes de SYS-03 |

---

## Description

Como equipe de infraestrutura, quero refatorar o scan global de 45+ entities para scan modular por modulo, e consolidar 65 migrations em uma baseline — para que o startup seja mais rapido, o acoplamento entre modulos seja reduzido, e novos ambientes sejam provisionados rapidamente.

---

## Technical Debts Addressed

### SYS-02: 45+ entities no scan global (ALTA - 2-4h)

**Arquivo:** `backend/src/config/typeorm.config.ts` (linhas 13-15)

**Problema:** Todas as entities sao carregadas via glob pattern:
```typescript
join(__dirname, '..', '**', '*.entity.ts')
```
Isso carrega 50+ entities globalmente, sem separacao por modulo. Consequencias:
- Startup mais lento (scan de filesystem)
- Acoplamento oculto entre modulos
- Impossivel carregar entities sob demanda

**Resolucao:**
1. Migrar para `TypeOrmModule.forFeature([Entity])` em cada modulo
2. Remover glob pattern do `typeorm.config.ts`
3. Registrar cada entity no seu respectivo modulo NestJS
4. Atualizar `app.module.ts` para nao importar entities diretamente

**Exemplo de modulo apos refatoracao:**
```typescript
@Module({
  imports: [TypeOrmModule.forFeature([Medicao])],
  controllers: [MedicoesController],
  providers: [MedicoesService],
  exports: [MedicoesService],
})
export class MedicoesModule {}
```

### SYS-03: 65 migrations com auto-run (ALTA - 4h)

**Diretorio:** `backend/src/migrations/` (65 arquivos)

**Problema:** Grande numero de migrations com `migrationsRun: true`. Cada startup de producao roda todas as 65 migrations sequencialmente, mesmo que ja executadas (o TypeORM verifica via tabela `migrations`, mas o scan e lento).

**Resolucao:**
1. Criar migration de **baseline** que consolida o schema final em um unico `CREATE TABLE` por entidade
2. Manter migrations existentes para ambientes ja provisionados (nao deletar)
3. Novos ambientes usam apenas a baseline + migrations posteriores
4. Adicionar script de deteccao: se tabela `migrations` nao existe, rodar baseline; senao, rodar incrementais

**CRITICO:** Este item DEVE ser o ULTIMO resolvido no epic completo de technical debt. Risco de breaking change em ambientes existentes.

**Restricoes:**
- Todas as 65 migrations sao DDL (sem DML) — confirmado pelo @data-engineer
- A baseline deve reproduzir o schema exato das 65 migrations combinadas
- Ambientes existentes com tabela `migrations` populada NAO devem rodar a baseline
- Verificar com `pg_dump --schema-only` que o schema gerado pela baseline e identico

---

## Acceptance Criteria

### SYS-02 (Entity Scan)
- [ ] Cada modulo NestJS registra suas proprias entities via `TypeOrmModule.forFeature()`
- [ ] Glob pattern removido de `typeorm.config.ts`
- [ ] Todas as 50+ entities registradas corretamente nos seus modulos
- [ ] Startup do backend funciona sem erros (entities encontradas)
- [ ] Nenhuma entity orfã (sem modulo registrando-a)
- [ ] Testes de integracao passam com novo scan modular

### SYS-03 (Migration Squash)
- [ ] Migration de baseline criada consolidando schema de 65 migrations
- [ ] Migrations originais mantidas (nao deletadas)
- [ ] Script de deteccao: novo ambiente → baseline; existente → incrementais
- [ ] `pg_dump --schema-only` identico entre baseline e migrations sequenciais
- [ ] Fresh install com baseline funciona e roda aplicacao normalmente
- [ ] Upgrade em ambiente existente (com migrations ja executadas) funciona normalmente
- [ ] Documentacao do processo de squash criada

---

## Test Plan

### SYS-02
- Teste de startup: `npm run start:dev` sem erros de entity not found
- Teste de integracao: CRUD de cada entity funciona
- Teste de modulo: cada modulo resolve suas entities internamente
- Verificar que `npm run build` produz output correto

### SYS-03
- **Fresh install:** Criar banco vazio → rodar baseline → verificar schema com `pg_dump`
- **Upgrade:** Banco com 65 migrations executadas → nao rodar baseline → tudo funciona
- **Comparacao:** `diff` entre schema de baseline e schema de migrations sequenciais
- **Smoke test:** Cadeia completa ETP → TR → Edital → Contrato → Medicao → Ateste

---

## Files Affected

| Arquivo | Mudanca |
|---------|---------|
| `backend/src/config/typeorm.config.ts` | Remover glob pattern de entities |
| `backend/src/app.module.ts` | Atualizar imports de TypeORM |
| Todos os `*.module.ts` (~35 modulos) | Adicionar `TypeOrmModule.forFeature([...])` |
| `backend/src/migrations/XXXXXXXXX-BaselineSchema.ts` | **NOVO** - Migration baseline |
| `docs/guides/migration-management.md` | **NOVO** - Documentacao de gerenciamento de migrations |

---

## Riscos

| Risco | Mitigacao |
|-------|-----------|
| Entity nao registrada em nenhum modulo → query falha | Criar checklist de todas as entities e verificar registro |
| Baseline diverge do schema real | Comparar via `pg_dump --schema-only` em ambos os caminhos |
| Ambiente existente roda baseline por engano | Deteccao robusta via tabela `migrations` |
| Circular dependency entre modulos (entity compartilhada) | Usar `forwardRef()` ou modulo compartilhado |

---

*Story criada em 2026-02-12 por @pm (Morgan) - AIOS v3.10.0*
