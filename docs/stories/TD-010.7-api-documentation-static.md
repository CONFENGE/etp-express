# Story TD-010.7: Static API Documentation (Redoc)

## Metadata
| Campo | Valor |
|-------|-------|
| **Parent Story** | TD-010 (Backlog - Infrastructure & Long-term Improvements) |
| **Priority** | P4 |
| **Estimated Effort** | 4h |
| **Area** | Frontend / API / DevOps |
| **Debts Addressed** | FE-05 |
| **Dependencies** | None |
| **Blocked By** | None |

---

## Description

Como equipe de produto, quero documentacao de API estatica acessivel publicamente, para que integradores terceiros possam consultar endpoints, schemas e exemplos sem depender do Swagger que esta intencionalmente desabilitado em producao.

---

## Technical Debt Addressed

### FE-05: Swagger desabilitado em producao sem doc API alternativa (BAIXA - 4h)

**Arquivo:** `backend/src/main.ts` (linhas 187-204)

**Configuracao atual:**
```typescript
if (nodeEnv !== 'production') {
  // Swagger setup...
  SwaggerModule.setup('docs', app, document);
} else {
  logger.warn('Swagger documentation disabled in production for security');
}
```

**Problema:** Decisao intencional de seguranca (nao expor schemas internos em prod), mas nao ha alternativa para integradores externos. A API publica de precos (endpoints `/api/v1/public/prices/*`) ja existe e precisa de documentacao acessivel.

**Resolucao:**
1. Gerar spec OpenAPI em build time (`swagger.json`)
2. Servir documentacao via Redoc estatico (HTML pre-renderizado)
3. Incluir apenas endpoints publicos (filtrar endpoints autenticados)
4. Deploy da documentacao como pagina estatica (ex: `/api-docs`)

---

## Implementacao Proposta

### Passo 1: Gerar spec OpenAPI em build time

```typescript
// scripts/generate-openapi.ts
import { NestFactory } from '@nestjs/core';
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
import { AppModule } from '../src/app.module';
import * as fs from 'fs';

async function generateSpec() {
  const app = await NestFactory.create(AppModule, { logger: false });
  const config = new DocumentBuilder()
    .setTitle('ETP Express - Public API')
    .setDescription('API publica de precos e market intelligence')
    .setVersion('1.0')
    .addApiKey({ type: 'apiKey', name: 'X-API-Key', in: 'header' })
    .build();

  const document = SwaggerModule.createDocument(app, config, {
    include: [PublicPricesModule], // Apenas modulos publicos
  });

  fs.writeFileSync('docs/api/openapi.json', JSON.stringify(document, null, 2));
  await app.close();
}
generateSpec();
```

### Passo 2: Renderizar Redoc estatico

```bash
npx @redocly/cli build-docs docs/api/openapi.json -o docs/api/index.html
```

### Passo 3: Servir em producao

Opcoes:
- **A)** Servir `docs/api/index.html` como arquivo estatico no NestJS (`ServeStaticModule`)
- **B)** Deploy separado em GitHub Pages / Vercel
- **C)** Adicionar rota `/api-docs` que serve o HTML

---

## Acceptance Criteria

- [ ] Script `generate-openapi.ts` criado para gerar spec em build time
- [ ] Spec OpenAPI inclui APENAS endpoints publicos (nao endpoints autenticados)
- [ ] Redoc HTML estatico gerado e funcional
- [ ] Documentacao acessivel em producao via URL publica (ex: `/api-docs`)
- [ ] API Key authentication documentada no spec (header `X-API-Key`)
- [ ] Exemplos de request/response incluidos nos endpoints
- [ ] Documentacao atualizada automaticamente em cada build/deploy
- [ ] Swagger continua desabilitado em producao (decisao de seguranca mantida)
- [ ] Todos os testes passam

---

## Test Plan

- Acessar `/api-docs` em producao â†’ renderiza pagina Redoc com documentacao
- Spec OpenAPI contem apenas endpoints `/api/v1/public/*`
- Spec nao contem endpoints internos (`/api/v1/etps`, `/api/v1/admin`, etc.)
- Schemas estao corretos e completos
- Exemplos de request/response funcionam quando copiados
- Try-it-out (se habilitado) funciona com API Key valida

---

## Files Affected

| Arquivo | Mudanca |
|---------|---------|
| `backend/scripts/generate-openapi.ts` | **NOVO** - Gerador de spec |
| `docs/api/openapi.json` | **NOVO** - Spec gerada (auto-commit) |
| `docs/api/index.html` | **NOVO** - Redoc HTML estatico |
| `backend/src/main.ts` | Adicionar rota para servir `/api-docs` |
| `backend/package.json` | Adicionar script `generate:api-docs` |
| `package.json` (raiz) | Adicionar `@redocly/cli` como devDependency |

---

*Story criada em 2026-02-12 por @pm (Morgan) - AIOS v3.10.0*
