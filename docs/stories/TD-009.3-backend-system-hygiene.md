# Story TD-009.3: Backend System Hygiene

## Metadata
| Campo | Valor |
|-------|-------|
| **Parent Story** | TD-009 (Code Quality - Schema Cleanup & System Hygiene) |
| **Priority** | P3 |
| **Estimated Effort** | 9h |
| **Area** | Backend / System |
| **Debts Addressed** | SYS-06, SYS-07, SYS-08, SYS-09 |
| **Dependencies** | None |
| **Blocked By** | None |
| **Status** | ✅ Done (Completed: 2026-02-13) |

---

## Description

Como equipe de desenvolvimento, quero resolver problemas de higiene no backend — body parser duplicado, guards globais sem documentacao, feature flags com persistencia ambigua, e modulo de chaos em diretorio de producao — para que o sistema seja seguro por design, auditavel e livre de riscos de deploy acidental.

---

## Technical Debts Addressed

### SYS-06: Body parser duplicado (MEDIA - 1h)

**Arquivo:** `backend/src/main.ts` (linhas 51-58)

**Problema:** O NestJS cria com `bodyParser: false` no `NestFactory.create()` e depois configura manualmente com `body-parser`:
```typescript
app.use(bodyParser.json({ limit: '10mb' }));
app.use(bodyParser.urlencoded({ limit: '10mb', extended: true }));
```
Isso e funcional mas fragil — o NestJS ja possui configuracao nativa de body parser via `NestFactory.create()` options.

**Resolucao:**
1. Remover import manual do `body-parser`
2. Usar a opcao nativa do NestJS:
```typescript
const app = await NestFactory.create(AppModule, {
  bodyParser: true,
  rawBody: true,
});
app.useBodyParser('json', { limit: '10mb' });
app.useBodyParser('urlencoded', { limit: '10mb', extended: true });
```
3. Remover dependencia `body-parser` do `package.json` (se nao usada em outro lugar)

### SYS-07: Guards globais via APP_GUARD (MEDIA - 2h)

**Arquivo:** `backend/src/app.module.ts` (linhas 291-302)

**Problema:** `TenantGuard` e `RolesGuard` registrados via `APP_GUARD` exigem `@Public()` em cada rota publica. Esquecer de decorar uma rota publica a torna inacessivel (403). O padrao e seguro (deny by default), mas precisa de documentacao e auditoria.

```typescript
providers: [
  { provide: APP_GUARD, useClass: TenantGuard },
  { provide: APP_GUARD, useClass: RolesGuard },
],
```

**Resolucao:**
1. Criar documentacao `docs/architecture/guards-and-auth.md` explicando:
   - Ordem de execucao: JwtAuthGuard → TenantGuard → RolesGuard
   - Como usar `@Public()` para rotas publicas
   - Como usar `@Roles()` para restricao de acesso
2. Auditar todas as rotas com `@Public()` — garantir que sao intencionalmente publicas
3. Adicionar comentarios nos guards sobre o padrao deny-by-default
4. Opcionalmente: criar linter rule customizada para avisar quando um controller nao tem `@Public()` nem `@Roles()`

### SYS-08: Feature flags sem persistencia clara (MEDIA - 4h)

**Arquivo:** `backend/src/modules/feature-flags/feature-flags.service.ts`

**Problema:** O modulo de feature flags ja usa Redis com in-memory cache fallback:
```typescript
private redis: Redis | null = null;
private readonly redisPrefix = 'ff:';
private readonly cacheTtlSeconds = 60;
private cache = new Map<string, { value: boolean; expiresAt: number }>();
```
O assessment original indicava "sem persistencia clara", mas a implementacao Redis ja existe. O debito real e:
1. Defaults hardcoded no servico (nao em banco/config)
2. Sem UI de admin para gerenciar flags
3. Sem audit trail de mudancas de flags

**Resolucao:**
1. Documentar o fluxo de feature flags: Redis como store, in-memory como fallback
2. Mover defaults para arquivo de configuracao (`feature-flags.defaults.ts`)
3. Adicionar log de auditoria quando uma flag e alterada (via controller)
4. Documentar procedimento operacional para ativar/desativar flags em producao

### SYS-09: Chaos module em src/ (MEDIA - 2h)

**Arquivos:**
- `backend/src/chaos/inbound-payload.chaos.spec.ts`
- `backend/src/modules/cache/chaos/redis-failure.chaos.spec.ts`
- `backend/src/modules/gov-api/chaos/api-timeout.chaos.spec.ts`
- `backend/src/modules/gov-api/chaos/large-payload.chaos.spec.ts`

**Problema:** Arquivos de chaos engineering estao em `src/` (diretorio de producao). Embora sejam `.spec.ts` e nao incluidos no build de producao, a localizacao causa confusao e risco conceitual.

**Resolucao:**
1. Verificar se os arquivos chaos sao apenas `.spec.ts` (testes) ou se ha modulos importaveis
2. Se apenas testes: manter no lugar (Jest os encontra automaticamente), mas documentar o padrao
3. Se houver modulos de producao: mover para `backend/test/chaos/` ou proteger com `NODE_ENV` check
4. Adicionar `chaos` ao `.eslintrc` como restricted import em producao (se aplicavel)

---

## Acceptance Criteria

- [x] Body parser configurado via API nativa do NestJS (sem `require('body-parser')`)
- [x] Dependencia `body-parser` removida do `package.json` (ou justificada se necessaria)
- [x] Documentacao `docs/architecture/guards-and-auth.md` criada com fluxo de guards
- [x] Auditoria de `@Public()` realizada — lista de rotas publicas documentada
- [x] Feature flags: defaults extraidos para arquivo de configuracao separado
- [x] Feature flags: log de auditoria implementado em mudancas de flags
- [x] Feature flags: documentacao operacional criada
- [x] Chaos module: arquivos avaliados e documentados/movidos conforme padrao
- [x] Chaos module: protecao contra import acidental em producao verificada
- [x] Todos os testes passam (`npm test`)
- [x] Build de producao funciona normalmente (`npm run build`)
- [x] Nenhuma regressao em rotas publicas ou autenticadas

---

## Test Plan

### SYS-06 (Body Parser)
- Teste de upload com payload > 10MB — deve retornar 413
- Teste de upload com payload < 10MB — deve funcionar
- Verificar que `Content-Type: application/json` e `application/x-www-form-urlencoded` funcionam

### SYS-07 (Guards)
- Teste E2E: rota sem `@Public()` nem auth token retorna 401/403
- Teste E2E: rota com `@Public()` sem auth token retorna 200
- Verificar ordem de execucao: JwtAuth → Tenant → Roles

### SYS-08 (Feature Flags)
- Teste unitario: flag alterada via controller gera log de auditoria
- Teste unitario: defaults carregados do arquivo de configuracao
- Teste de integracao: Redis down → fallback para in-memory funciona

### SYS-09 (Chaos Module)
- Verificar que `npm run build` nao inclui arquivos chaos
- Verificar que `import` de modulo chaos em codigo de producao gera erro de lint

### Regressao
- Suite completa `npm test` e `npm run build` passam
- Health check em producao funciona apos deploy

---

## Files Affected

| Arquivo | Mudanca |
|---------|---------|
| `backend/src/main.ts` | Refatorar body parser para API nativa NestJS |
| `backend/package.json` | Remover `body-parser` (se possivel) |
| `backend/src/app.module.ts` | Documentar guards, adicionar comentarios |
| `docs/architecture/guards-and-auth.md` | **NOVO** - Documentacao de guards |
| `backend/src/modules/feature-flags/feature-flags.service.ts` | Extrair defaults |
| `backend/src/modules/feature-flags/feature-flags.defaults.ts` | **NOVO** - Defaults centralizados |
| `docs/guides/feature-flags-ops.md` | **NOVO** - Guia operacional |
| `backend/src/chaos/` | Avaliar e documentar/mover |
| Testes unitarios | Atualizar conforme mudancas |

---

*Story criada em 2026-02-12 por @pm (Morgan) - AIOS v3.10.0*
